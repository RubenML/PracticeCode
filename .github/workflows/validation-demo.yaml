name: Manifest and Kubernetes Object Validation
on:
  [push]
jobs: 
  validate:
    runs-on: ubuntu-latest
    container: deck15/kubeval-tools:latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set output
        id: getdiff
        run: echo "::set-output name=diff::$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | sed ':a;N;$!ba;s/\n/ /g')"

      - name: Final step
        run: echo "${{ steps.getdiff.outputs.diff }}"

      - name: yamlint validation
        run: yamllint --format colored ${{ steps.getdiff.outputs.diff }}
        continue-on-error: true

      - name: kubelinter validation
        run: kube-linter lint ${{ steps.getdiff.outputs.diff }}
        continue-on-error: true

      - name: kubeval validation
        run: kubeval ./*/*/*
        continue-on-error: true
